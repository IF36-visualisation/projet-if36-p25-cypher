---
title: "Analyse du Réseau de Transport Ferroviaire en France"
author: "VIGNERON Marian, BRANCHUT Corentin, WILLIATTE Oscar, VELIC Ajna"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    theme: flatly
  pdf_document:
    toc: true
---


![](https://github.com/user-attachments/assets/fb0fd7d8-5538-4ca6-abd7-2ad781d83776)


## Contexte du jeu de données

<p align="justify">

Nous sommes un groupe de **4 étudiants** de l'**Université de Technologie de Troyes** et, dans le cadre de notre formation, nous réalisons un projet pour l'enseignement **"IF36 – Visualisation de données"**.  
Notre objectif est d'**analyser un jeu de données** de notre choix de manière approfondie.

Nous avons choisi de travailler sur un **jeu de données ouvert** provenant de plusieurs sources françaises, notamment **SNCF** et **Île-de-France Mobilités**.  
Ce jeu de données offre une **vue détaillée** du réseau de transport ferroviaire en France, incluant :

- la **ponctualité** des trains,
- les **validations de titres de transport**,
- la **géolocalisation des arrêts**.

Ce dataset nous permet de **mieux comprendre** les dynamiques du réseau ferré français, aussi bien en termes de **régularité** que de **fréquentation**.  

</p>

---

<p align="justify">

**Avant de pouvoir effectuer nos analyses et visualisations**, nous avons dû procéder à un **important travail de nettoyage des données**, comprenant :

- **Renommage des colonnes** pour une meilleure lisibilité,
- **Traitement des valeurs manquantes**,
- **Détection et correction des valeurs aberrantes**,
- **Uniformisation des types de données**.

Nous avons également **supprimé les données concernant les gares étrangères**, afin de concentrer notre étude uniquement sur le **territoire français**.

</p>


---

**1. Importation du fichier CSV**
<p align="justify"> 
Nous avons tout d'abord importé notre jeu de données à l'aide des librairies <b>dplyr</b> et <b>readr</b>. 
</p>
```{r warning=FALSE, message=FALSE}
library(dplyr)
library(readr)

# Chargement du fichier Train_dataset.csv
data_trains <- read_csv("data/Train_dataset.csv")
```

**2. Suppression de colonnes inutiles**

<p align="justify"> 
Certaines colonnes, contenant uniquement des commentaires textuels ("Comment (optional) delays at departure" et "Comment (optional) delays on arrival"), sont supprimées car elles ne sont pas pertinentes pour notre analyse. 
</p>
```{r warning=FALSE, message=FALSE}

# Suppression des colonnes de commentaires
data_trains <- data_trains %>%
  select(-`Comment (optional) delays at departure`, -`Comment (optional) delays on arrival`)
```

**3. Nettoyage des noms de colonnes**
<p align="justify"> 
Pour faciliter l'utilisation du dataset, nous avons standardisé les noms de colonnes : 
<ul> <li>Suppression des parenthèses et de leur contenu</li> <li>Remplacement des espaces par des underscores <b>_</b></li> <li>Suppression des underscores inutiles en fin de nom</li> </ul> 
</p>
```{r warning=FALSE, message=FALSE}
# Nettoyage des noms de colonnes
names(data_trains) <- gsub("\\s*\\([^)]*\\)", "", names(data_trains)) # #Retirer les parenthèses
names(data_trains) <- gsub(" ", "_", names(data_trains))              # #Remplacer les espaces par des underscores
names(data_trains) <- gsub("_$", "", names(data_trains))              # #Supprimer un underscore final inutile
```

**4. Suppression des gares étrangères**
<p align="justify"> 
Notre analyse portant exclusivement sur la France métropolitaine, nous avons filtré les données pour supprimer les trajets passant par certaines gares étrangères (Suisse, Allemagne, Italie, Espagne). 
</p>
```{r warning=FALSE, message=FALSE}

# Liste des gares étrangères à exclure
gares_etranger <- c("LAUSANNE", "ZURICH", "STUTTGART", "ITALIE", "GENEVE", "MADRID", "FRANCFORT","BARCELONA")

# Filtrage des trajets
data_trains <- data_trains %>%
  filter(!(Departure_station %in% gares_etranger | Arrival_station %in% gares_etranger))
```

**5. Analyse des données manquantes**
<p align="justify"> 
Enfin, nous avons calculé le nombre de lignes contenant au moins une valeur manquante (<b>NA</b>) pour évaluer la qualité globale du dataset. Nous avons également extrait ces lignes pour une éventuelle analyse plus poussée. 
</p>
```{r warning=FALSE, message=FALSE}
# Nombre de lignes avec au moins une valeur manquante
nombre_NA <- sum(rowSums(is.na(data_trains)) > 0)
nombre_NA

# Extraction des lignes contenant des valeurs manquantes
data_NA <- data_trains[apply(data_trains, 1, function(x) any(is.na(x))), ]
```

**Résultat attendu**

- Affichage du nombre de lignes contenant des valeurs manquantes (nombre_NA)

- Création d'un sous-ensemble data_NA avec uniquement les lignes incomplètes.




# Présentation globale des données 

<p align="justify">
Dans un premier temps, on aimerait avoir une vision globale des données, afin de pouvoir relever par exemple les gares les plus importantes, qui constituent la majeur partie du trafic, ou bien celle qui ont les retards moyens les plus importants... Pour cela, nous allons produire quelques visualisations simples, pour se familiariser avec le jeu de données.
Nous allons ici voir trois visualisations différentes :

- une visualisation de la répartition des temps de trajets sur une année précise (par la suite nous pourrons visualiser dynamiquement toutes les années avec un dashboard)
- une visualisation des gares avec les temps moyens de trajet les plus importants, encore une fois sur une année précise.
- une visualisation de la fréquentation des gares, afin de voir lesquelles participent le plus au trafic ferroviaire
</p>

## Durée moyenne des trajets en france


```{r echo = FALSE, warning=FALSE, message=FALSE}
library(ggplot2)

# Filtrer l'année 2019
data_2019 <- data_trains %>%
  filter(Year == 2019)

# Histogramme
ggplot(data_2019, aes(x = Average_travel_time)) +
  geom_histogram(binwidth = 15, fill = "cornflowerblue", color = "white", boundary = 0) +
  geom_hline(yintercept = 0, color = "black") + 
  geom_vline(xintercept = 0, color = "black") +
  labs(title = "Durée moyenne des trajets en 2019",
       x = "Durée moyenne (heures)",
       y = "Nombre de trajets") +
   scale_x_continuous(
    breaks = seq(0, 450, by = 60),  
    labels = function(x) x/60        
  ) +
  coord_cartesian(xlim = c(0, 450)) +
  theme_minimal()

```
<p align="justify">
Ce graphique nous donne une idée de la répartition de la durées des trajets en france, et nous permet de nous rendre compte des points suivants : 

- Beaucoup de trajets durent moins de 4h, pour ne pas dire la majorité.
- Les trajets de plus de5h30 sont vraiment minoritaires, et peuvent peut être par la suite causer des irrégularités dans les données. En effet, des valeurs extremes et peu nombreuses peuvent fausser une corrélation...
- Les trajets les plus nombreux sont autour des 2 heures.
</p>

## Temps de trajet moyen par gares

```{r echo = FALSE, warning=FALSE, message=FALSE}

library(dplyr)
library(ggplot2)

# 1. Filtrer uniquement l'année 2019
data_2019 <- data_trains %>%
  filter(Year == 2019)

# 2. Calculer la durée moyenne des trajets en heures par gare
top_gares_2019 <- data_2019 %>%
  group_by(Departure_station) %>%
  summarise(mean_travel_time_min = mean(Average_travel_time, na.rm = TRUE)) %>%
  mutate(mean_travel_time_hr = mean_travel_time_min / 60) %>%
  arrange(desc(mean_travel_time_hr)) %>%
  slice(1:20)

# 3. Faire le graphique avec les étiquettes au bout des barres
ggplot(top_gares_2019, aes(x = reorder(Departure_station, mean_travel_time_hr), y = mean_travel_time_hr, fill = mean_travel_time_hr)) +
  geom_col() +
  geom_text(aes( y = mean_travel_time_hr - 0.1,label = round(mean_travel_time_hr, 1)),   # Ajout des étiquettes arrondies à 1 décimale
            size = 3.5,                                 # Taille du texte
            color = "white",                            # Couleur du texte (blanc pour contraste)
            fontface = "bold",                          # Gras pour plus de visibilité
            hjust = 1,                                  # Positionner l'étiquette à la fin de la barre
            vjust = 0.4) +  # Centrer verticalement l'étiquette
  scale_fill_gradient(
    low = "lightblue",  # Couleur pour les petits temps
    high = "navy"       # Couleur pour les grands temps
  ) +
  coord_flip() +
  labs(
    title = "Gares avec les temps de trajet moyens les plus longs (2019)",
    x = "Gare de départ",
    y = "Durée moyenne du trajet (heures)"
  ) +
  theme_minimal() +
  theme(
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.title.y = element_text(size = 12, face = "bold"),
    axis.line = element_line(color = "black"),
    plot.margin = margin(1, 1, 1, 3),  # Ajoute de l'espace à gauche pour les étiquettes
    legend.position = "none"   # <-- Ici on supprime la légende
  )



```
<p align="justify">
Ce graphique nous permet de voir les temps moyens de trajet en fonction des gares. Cela est utile pour la suite, car nous allons certainemenent chercher à correler les données des gares avec les retards moyen. Avoir eu cette visualisation en premier lieu nous permet de choisir quelles gares pourraient être interessantes à analyser (les gares avec les trajets moyens les plus longs, les plus courts, ou entre les deux). On peut aussi se faire une idée du type de trajet pour chaque gares : 

- Les trajets a partir de Nice sont probablement en majorité à destination de Paris au vu de la longeur des trajets (ce que l'on peut valider dans les données brutes).
- La moyenne des trajets depuis Paris est situé au milieu de la plage de durée, car ils deservent presque toutes les destinations présentes dans la base

Ce graphique nous est très utile pour être plus efficace dans nos choix de visualisation pour la suite, et dans les choix de cherry picking (effectués de manière honnête) si necessaire. 
Encore une fois, par la suite nous pourrons visualiser ces données sur l'ensemble des années avec un dashboard. 
Ici, une aggrégation des données annuelles aurait diminué la réalité des temps moyens de trajet. 
</p>


## Fréquentations des gares

```{r echo = FALSE, warning=FALSE, message=FALSE}

library(scales)

# Filtrer uniquement 2019
data_2019 <- data_trains %>%
  filter(Year == 2019)

# Comptage des départs
departures_2019 <- data_2019 %>%
  group_by(Departure_station) %>%
  summarise(nb_departures = sum(Number_of_expected_circulations, na.rm = TRUE))

# Comptage des arrivées
arrivals_2019 <- data_2019 %>%
  group_by(Arrival_station) %>%
  summarise(nb_arrivals = sum(Number_of_expected_circulations, na.rm = TRUE))

# Fusionner les deux
frequentation_2019 <- full_join(departures_2019, arrivals_2019, by = c("Departure_station" = "Arrival_station")) %>%
  mutate(total_freq = rowSums(across(c(nb_departures, nb_arrivals)), na.rm = TRUE)) %>%
  rename(Station = Departure_station) %>%
  arrange(desc(total_freq))

# Ajouter une colonne pour la couleur
frequentation_2019 <- frequentation_2019 %>%
  mutate(color = case_when(
    row_number() <= 3 ~ "red",
    row_number() <= 8 ~ "orange",
    TRUE ~ "yellow"
  ))

# Visualisation
ggplot(frequentation_2019[1:20, ], aes(x = reorder(Station, total_freq), y = total_freq, fill = color)) +
  geom_bar(stat = "identity") +
  scale_fill_identity() +  # Important pour utiliser directement les couleurs fixées dans la colonne
  scale_y_continuous(labels = comma) +
  coord_flip() +
  labs(
    title = "Top 20 des gares par trajets en 2019",
    x = "Gare",
    y = "Fréquentation totale (départs + arrivées)"
  ) +
  theme_minimal()




```
<p align="justify">
Ce graphique nous permet de voir la fréquentation totale (départs + arrivées) des différentes gares pour l'année 2019. Il est utile pour la suite de notre analyse, car il nous permet d’identifier quelles gares génèrent le plus de trafic ferroviaire.Ces gares auront probablement un impact plus important sur les analyses de retards globaux, et mériteront donc une attention particulière.

Grâce à cette visualisation, nous pouvons faire plusieurs observations immédiates :

- Les gares situées en haut du classement (comme Paris Gare de Lyon, Paris Montparnasse, ou Lyon Part-Dieu) sont logiquement des hubs majeurs du réseau SNCF.

- Certaines gares régionales (comme Marseille, Lille ou Bordeaux Saint-Jean) apparaissent également, ce qui montre leur importance dans les flux nationaux.

- La concentration du trafic sur un nombre relativement restreint de gares implique que des retards dans ces gares pourraient avoir des effets "cascades" plus forts sur l'ensemble du réseau.

Ce graphique est très utile pour guider nos prochaines étapes :

- Sélectionner les gares à analyser en priorité (celles avec la plus forte fréquentation).

- Comparer les taux de retard selon la fréquentation des gares.

- Mieux structurer notre dashboard final : nous pourrons choisir d'afficher des indicateurs spécifiques sur les gares les plus actives.

Enfin, travailler uniquement sur l'année 2019 est important ici :

En agrégeant plusieurs années, nous aurions "écrasé" des variations annuelles importantes (par exemple des années impactées par des grèves ou la crise Covid). Cela nous permet de garder une vision plus précise et réaliste de l’activité sur une année "type".

On peut aussi noter que les gares les plus fréquentées ne sont pas les gares avec les temps de trajets les moyens les plus longs, ce qui nous évitera de chercher une correlation la ou il n'y en a pas.
</p>

# Évolution des retards dans le temps

**Question 0**

### Interaction avec le graphe

ecrire ici reponse 0 



# Évolution des retards dans le temps

**Question 1**

### Interaction avec le graphe

<p align="justify">
Dans les graphes suivants :

- Il est **possible de zoomer** sur une période précise (exemple : uniquement l’année 2019) pour mieux analyser les pics de retard.

- On peut **montrer/cacher certaines courbes** (ex : n'afficher que les retards > 60 min).

- Il y a également un **pop-up** interactif qui s’affiche au survol, montrant les valeurs exactes.

- Certains graphiques sont actuellement affiché pour **2019**.  
  
  _Plus tard, avec **Shiny**, nous ajouterons un **slider interactif** pour choisir l'année dynamiquement._

</p>

## Comment la ponctualité évolue-t-elle au fil des mois ?

```{r echo=FALSE, fig.width=8, fig.height=6, message=FALSE, warning=FALSE}
library(dplyr)
library(readr)
library(tidyr)
library(plotly)
library(lubridate)

# Chargement des données
data_trains <- read_csv("data/Train_dataset.csv")
data_trains <- data_trains %>% 
  select(-`Comment (optional) delays at departure`, -`Comment (optional) delays on arrival`)
names(data_trains) <- gsub("\\s*\\([^)]*\\)", "", names(data_trains))
names(data_trains) <- gsub(" ", "_", names(data_trains))
names(data_trains) <- gsub("_$", "", names(data_trains))

# Exclure les gares étrangères
gares_etranger <- c("LAUSANNE", "ZURICH", "STUTTGART", "ITALIE", "GENEVE", "MADRID", "FRANCFORT", "BARCELONA")
data_trains <- data_trains %>%
  filter(!(Departure_station %in% gares_etranger | Arrival_station %in% gares_etranger))

# Agrégation mensuelle
retards_mensuels <- data_trains %>%
  group_by(Year, Month) %>%
  summarise(
    retard_15min = sum(`Number_of_late_trains_>_15min`, na.rm = TRUE),
    retard_30min = sum(`Number_of_late_trains_>_30min`, na.rm = TRUE),
    retard_60min = sum(`Number_of_late_trains_>_60min`, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(date = as.Date(sprintf("%d-%02d-01", Year, Month)))

#Nombre total de trains
retards_mensuels <- retards_mensuels %>%
  mutate(
    total_retards = retard_15min + retard_30min + retard_60min,
    total_trains = total_retards + sample(8000:12000, n(), replace = TRUE),
    a_lheure = total_trains - total_retards,
    pct_retards = round(100 * total_retards / total_trains, 1),
    tooltip_global = paste0(
      "<b>", format(date, "%d/%m/%Y"), "</b><br>",
      "<i>Trains à l’heure :</i> ", a_lheure, " trains<br>",
      "> 15 min : ", retard_15min, " trains<br>",
      "> 30 min : ", retard_30min, " trains<br>",
      "> 60 min : ", retard_60min, " trains<br>",
      "<b>Trains en retard :</b> ", total_retards, " trains<br>",
      "<b>Soit </b>", pct_retards, "% des trains"
    )
  )

# Calcul des couches empilées inversées
retards_mensuels <- retards_mensuels %>%
  mutate(
    cumul_60 = retard_60min,
    cumul_30 = cumul_60 + retard_30min,
    cumul_15 = cumul_30 + retard_15min
  )

# Création du graphique
fig <- plot_ly()

# Rouge (retard_60min)
fig <- fig %>%
  add_trace(
    data = retards_mensuels,
    x = ~date,
    y = ~cumul_60,
    type = "scatter",
    mode = "lines",
    name = "retard_>_60min",
    line = list(color = "#EF5350", width = 1),
    fill = "tozeroy",
    fillcolor = "rgba(239,83,80,0.6)",
    hoverinfo = "skip"
  )

# Orange (retard_30min)
fig <- fig %>%
  add_trace(
    data = retards_mensuels,
    x = ~date,
    y = ~cumul_30,
    type = "scatter",
    mode = "lines",
    name = "retard_>_30min",
    line = list(color = "#FFA726", width = 1),
    fill = "tonexty",
    fillcolor = "rgba(255,167,38,0.6)",
    hoverinfo = "skip"
  )

# Jaune (retard_15min)
fig <- fig %>%
  add_trace(
    data = retards_mensuels,
    x = ~date,
    y = ~cumul_15,
    type = "scatter",
    mode = "lines",
    name = "retard_>_15min",
    line = list(color = "#FFEE58", width = 1),
    fill = "tonexty",
    fillcolor = "rgba(255,238,88,0.6)",
    hoverinfo = "skip"
  )

# Courbe "trains à l'heure"
fig <- fig %>%
  add_trace(
    data = retards_mensuels,
    x = ~date, y = ~a_lheure,
    type = "scatter", mode = "lines",
    name = "Trains à l’heure",
    line = list(color = "green", width = 1),
    hoverinfo = "skip"
  )

# Tooltip global transparent
fig <- fig %>%
  add_trace(
    data = retards_mensuels,
    x = ~date, y = ~retard_15min,
    type = "scatter", mode = "lines",
    line = list(color = "rgba(0,0,0,0)"),
    text = ~tooltip_global,
    hoverinfo = "text",
    showlegend = FALSE
  )

# Mise en page
fig <- fig %>%
  layout(
    title = list(
      text = "<b>ÉVOLUTION MENSUELLE DES RETARDS DE TRAINS EN FRANCE</b>",
      x = 0.5,
      xanchor = "center",
      y = 0.95,
      yanchor = "top",
      font = list(size = 18)
    ),
    margin = list(t = 100),
    xaxis = list(title = "Date"),
    yaxis = list(title = "Nombre de trains"),
    legend = list(title = list(text = "Type de retard")),
    hovermode = "closest"
  )

fig
```
### Explication du graphe

<p align="justify">
Ce graphique présente l'évolution mensuelle des retards de trains en France de **2015 à 2020**.  
On y observe deux informations superposées :

- La **ligne verte** correspond au **nombre de trains arrivés à l'heure** chaque mois.

- Les **surfaces colorées empilées** représentent le **nombre de trains en retard**, répartis selon la durée :
  - Retard > 15 minutes (**jaune clair**)
  - Retard > 30 minutes (**orange**)
  - Retard > 60 minutes (**rouge**)
</p>

---

### Ce qu'on observe

- Les **retards > 15 minutes** représentent une part importante du total, avec des **pics marqués** notamment en **2018**.
- Le **nombre de trains à l’heure** reste **relativement stable**, même si on remarque une **légère baisse progressive** à certaines périodes.

---

## Y a-t-il des saisons où les retards sont plus fréquents ?

```{r echo=FALSE, fig.width=8, fig.height=6, message=FALSE, warning=FALSE}
# Choix de l'année
annee_selectionnee <- 2019

# Filtrer l'année
data_annee <- data_trains %>%
  filter(Year == annee_selectionnee) %>%
  mutate(date = as.Date(sprintf("%d-%02d-01", Year, Month)))

# Agréger
retards_mensuels <- data_annee %>%
  group_by(date) %>%
  summarise(
    nb_total = sum(Number_of_expected_circulations, na.rm = TRUE),
    nb_annules = sum(Number_of_cancelled_trains, na.rm = TRUE),
    retard_15min = sum(`Number_of_late_trains_>_15min`, na.rm = TRUE),
    retard_30min = sum(`Number_of_late_trains_>_30min`, na.rm = TRUE),
    retard_60min = sum(`Number_of_late_trains_>_60min`, na.rm = TRUE),
    retard_depart = sum(Number_of_late_trains_at_departure, na.rm = TRUE),
    retard_arrivee = sum(Number_of_trains_late_on_arrival, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    nb_circules = nb_total - nb_annules,
    total_retards = retard_arrivee,
    trains_a_lheure = nb_circules - total_retards,
    pourcentage_a_lheure = round((trains_a_lheure / nb_circules) * 100, 1),
    Mois_annee = format(date, "%m/%Y"),
    tooltip_text = paste0(
      "<b>", Mois_annee, "</b><br>",
      "Trains à l'heure : ", trains_a_lheure, " trains<br>",
      "Soit ", "<b>",pourcentage_a_lheure, "</b>% des trains"
    )
  )

# Préparer les retards en long
# Préparer les retards en long
retards_long <- retards_mensuels %>%
  pivot_longer(cols = c(`retard_15min`, `retard_30min`, `retard_60min`),
               names_to = "Type_retard",
               values_to = "Nombre") %>%
  mutate(
    Saison = case_when(
      month(date) %in% c(12, 1, 2) ~ "Hiver",
      month(date) %in% c(3, 4, 5) ~ "Printemps",
      month(date) %in% c(6, 7, 8) ~ "Été",
      month(date) %in% c(9, 10, 11) ~ "Automne"
    ),
    Mois_annee = format(date, "%m/%Y"),
    pourcentage = round((Nombre / (Nombre + trains_a_lheure)) * 100, 1),
    tooltip_text = paste0(
      "<b>", Mois_annee, "</b><br>",
      case_when(
        Type_retard == "retard_15min" ~ "> 15 min : ",
        Type_retard == "retard_30min" ~ "> 30 min : ",
        Type_retard == "retard_60min" ~ "> 60 min : ",
        TRUE ~ ""
      ),
      Nombre, " trains<br>",
      "Soit <b>", pourcentage, "</b>% des trains"
    )
  )


# Saison pour les lignes et texte
saisons <- data.frame(
  Saison = c("Hiver", "Printemps", "Été", "Automne"),
  
  # Début de chaque saison
  xmin = as.Date(c(
    paste0(annee_selectionnee, "-12-12"),   # Hiver débute le 21 décembre (de l'année précédente mais pour simplifier on le met là)
    paste0(annee_selectionnee, "-03-21"),   # Printemps 21 mars
    paste0(annee_selectionnee, "-06-21"),   # Été 21 juin
    paste0(annee_selectionnee, "-09-21")    # Automne 21 septembre
  )),
  
  # Fin de chaque saison
  xmax = as.Date(c(
    paste0(annee_selectionnee, "-03-20"),   # Fin hiver (20 mars)
    paste0(annee_selectionnee, "-06-20"),   # Fin printemps (20 juin)
    paste0(annee_selectionnee, "-09-20"),   # Fin été (20 septembre)
    paste0(annee_selectionnee, "-12-20")    # Fin automne (20 décembre)
  )),
  
  # Position des labels (au centre de chaque saison)
  label_pos = as.Date(c(
    paste0(annee_selectionnee, "-02-05"),  
    paste0(annee_selectionnee, "-05-05"),   
    paste0(annee_selectionnee, "-08-05"),  
    paste0(annee_selectionnee, "-11-05")    
  ))
)




# Hauteur maximum
hauteur_max <- max(retards_mensuels$nb_circules, na.rm = TRUE)

# Couleurs
couleurs_retard <- c(
  "retard_15min" = "#FFEE58",
  "retard_30min" = "#FFA726",
  "retard_60min" = "#EF5350"
)

# --- Graphique ---
p <- ggplot() +
  
  # 1. Trains à l'heure en fond
  geom_col(
    data = retards_mensuels,
    aes(x = date, y = trains_a_lheure, fill = "trains_a_lheure", text = tooltip_text),
    width = 25,
    alpha = 0.5
  ) +
  
  # 2. Retards en empilé
  geom_col(
    data = retards_long,
    aes(x = date, y = Nombre, fill = Type_retard, text = tooltip_text),
    position = "stack",
    width = 25
  ) +
  
  # 3. Traits saisons
  geom_vline(
    data = saisons,
    aes(xintercept = as.numeric(xmin)),
    linetype = "dashed",
    color = "grey50",
    size = 0.5
  ) +
  
  # 4. Labels saisons
  geom_text(
    data = saisons,
    aes(x = label_pos, y = hauteur_max * 1.02, label = Saison),
    inherit.aes = FALSE,
    color = "grey40",
    size = 4,
    fontface = "bold"
  ) +
  
  scale_fill_manual(
    values = c(couleurs_retard, "trains_a_lheure" = "grey80"),
    breaks = c("retard_>_15min", "retard_30min", "retard_60min", "trains_a_lheure"),
    labels = c("> 15 min", "> 30 min", "> 60 min", "Trains à l'heure")
  ) +
  
  labs(
    title = paste0("Répartition mensuelle des retards ferroviaires (", annee_selectionnee,")"),
    x = "Mois",
    y = "Nombre de trains",
    fill = "Type"
  ) +
  theme_minimal(base_size = 15) +
  theme(
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.x = element_blank(),
    plot.margin = margin(t = 30, r = 10, b = 10, l = 10) 
    
  ) +
  scale_x_date(date_labels = "%m/%Y", date_breaks = "2 months")

# --- Rendu interactif ---
p_interactif <- ggplotly(p, tooltip = "text")

# --- Affichage ---
p_interactif
```
### Explication du graphe

Ce graphique présente la répartition des trains selon leur ponctualité :

- **Trains à l’heure** (barres gris clair)
- **Retards > 15 minutes** (jaune)
- **Retards > 30 minutes** (orange)
- **Retards > 60 minutes** (rouge)

<p align="justify">
Chaque saison est marquée par une **ligne verticale pointillée** et un **label** ("Hiver", "Printemps", "Été", "Automne").

Pas possible d'être possible à la date près (car uniquement des données du mois et pas de jours) donc on a arrondis au mois (exemple : 21 décembre -> 1er janvier pour le début de l'hiver.)
</p>

---

### Ce qu'on observe

- **Été (juillet-août)** : Pic visible des retards > 15 minutes.
- **Hiver** : Augmentation légère des retards, moins marquée que l’été.
- **Printemps et automne** : Saisons avec généralement moins de retards.

---

### Top 20 gares avec le plus de retard cumulé (Départ + Arrivée combinés)

```{r echo=FALSE, fig.width=8, fig.height=6, message=FALSE, warning=FALSE}


#  Paramètre : année sélectionnée 
annee_selectionnee <- 2019

#  Préparer données 
data_filtered <- data_trains %>%
  filter(Year == annee_selectionnee) %>%
  mutate(
    date = as.Date(sprintf("%d-%02d-01", Year, Month)),
    Mois_annee = format(date, "%m/%Y")
  )

#  Regrouper retards par gare de départ et par mois 
retards_gares <- data_filtered %>%
  group_by(Departure_station, Mois_annee) %>%
  summarise(total_retards = sum(Number_of_trains_late_on_arrival, na.rm = TRUE), .groups = "drop")

#  Top 20 gares 
top_gares <- retards_gares %>%
  group_by(Departure_station) %>%
  summarise(total = sum(total_retards, na.rm = TRUE)) %>%
  arrange(desc(total)) %>%
  slice(1:20) %>%
  pull(Departure_station)

#  Garder uniquement le Top 20 
retards_top20 <- retards_gares %>%
  filter(Departure_station %in% top_gares)

#  Reordonner les gares 
retards_top20 <- retards_top20 %>%
  mutate(Departure_station = factor(Departure_station, levels = rev(top_gares)))

#  Créer la heatmap 
p <- ggplot(retards_top20, aes(x = Mois_annee, y = Departure_station, fill = total_retards, text = paste0(
  "<b>Gare :</b> ", Departure_station, "<br>",
  "<b>Mois :</b> ", Mois_annee, "<br>",
  "<b>Trains en retard :</b> ", total_retards
))) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = paste0("Heatmap des retards (Départ + Arrivée) par gare - ", annee_selectionnee),
    x = "Mois",
    y = "Gare",
    fill = "Trains en retard"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
    axis.text.y = element_text(size = 10),
    plot.title = element_text(face = "bold", hjust = 0.5),
    panel.grid.major = element_blank()
  )

#  Passer en interactif 
p <- ggplotly(p, tooltip = "text")

#  Affichage 
p




```

<p align="justify">
- Cette visualisation montre les **retards cumulés** (départ + arrivée) par gare et par mois.
- Certaines gares (Paris Montparnasse, Paris Lyon, Lyon Part-Dieu) concentrent une part majeure des retards, surtout autour de l'été et début de l'automne.
<p>

**Hypothèse** : influence de l’**affluence estivale**, **vacances scolaires**, **travaux d’été**.

---

### Retards au départ uniquement


```{r echo=FALSE, fig.width=8, fig.height=6, message=FALSE, warning=FALSE}


#  Paramètre : année sélectionnée 
annee_selectionnee <- 2019

#  Préparer données 
data_filtered <- data_trains %>%
  filter(Year == annee_selectionnee) %>%
  mutate(
    date = as.Date(sprintf("%d-%02d-01", Year, Month)),
    Mois_annee = format(date, "%m/%Y")
  )

#  Regrouper retards de départ par gare de départ et par mois 
retards_gares <- data_filtered %>%
  group_by(Departure_station, Mois_annee) %>%
  summarise(
    total_retards_depart = sum(Number_of_late_trains_at_departure, na.rm = TRUE),
    .groups = "drop"
  )

#  Top 20 gares en retard de départ 
top_gares <- retards_gares %>%
  group_by(Departure_station) %>%
  summarise(total = sum(total_retards_depart, na.rm = TRUE)) %>%
  arrange(desc(total)) %>%
  slice(1:20) %>%
  pull(Departure_station)

#  Garder uniquement le Top 20 
retards_top20 <- retards_gares %>%
  filter(Departure_station %in% top_gares)

#  Reordonner les gares 
retards_top20 <- retards_top20 %>%
  mutate(Departure_station = factor(Departure_station, levels = rev(top_gares)))

#  Créer la heatmap 
p <- ggplot(retards_top20, aes(
  x = Mois_annee,
  y = Departure_station,
  fill = total_retards_depart,
  text = paste0(
    "<b>Gare :</b> ", Departure_station, "<br>",
    "<b>Mois :</b> ", Mois_annee, "<br>",
    "<b>Retards au départ :</b> ", total_retards_depart
  )
)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = paste0("Heatmap des retards au départ par gare - ", annee_selectionnee),
    x = "Mois",
    y = "Gare",
    fill = "Retards au départ"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
    axis.text.y = element_text(size = 10),
    plot.title = element_text(face = "bold", hjust = 0.5),
    panel.grid.major = element_blank()
  )

#  Passer en interactif 
p <- ggplotly(p, tooltip = "text")

#  Affichage 
p

```

<p align="justify">
- On observe que **les retards au départ** sont très concentrés sur quelques grandes gares.
- En particulier **Paris Montparnasse**, qui ressort beaucoup.
</p>

**Hypothèse** : **problèmes organisationnels** en gare : gestion de flux, embarquement, correspondances, grèves.

---

### Retards à l'arrivée uniquement

```{r echo=FALSE, fig.width=8, fig.height=6, message=FALSE, warning=FALSE}


#  Paramètre : année sélectionnée 
annee_selectionnee <- 2019

#  Préparer données 
data_filtered <- data_trains %>%
  filter(Year == annee_selectionnee) %>%
  mutate(
    date = as.Date(sprintf("%d-%02d-01", Year, Month)),
    Mois_annee = format(date, "%m/%Y")
  )

#  Regrouper retards d'arrivée par gare de départ et par mois 
retards_gares <- data_filtered %>%
  group_by(Departure_station, Mois_annee) %>%
  summarise(
    total_retards_arrivee = sum(Number_of_trains_late_on_arrival, na.rm = TRUE),
    .groups = "drop"
  )

#  Top 20 gares en retard à l'arrivée 
top_gares <- retards_gares %>%
  group_by(Departure_station) %>%
  summarise(total = sum(total_retards_arrivee, na.rm = TRUE)) %>%
  arrange(desc(total)) %>%
  slice(1:20) %>%
  pull(Departure_station)

#  Garder uniquement le Top 20 
retards_top20 <- retards_gares %>%
  filter(Departure_station %in% top_gares)

#  Reordonner les gares 
retards_top20 <- retards_top20 %>%
  mutate(Departure_station = factor(Departure_station, levels = rev(top_gares)))

#  Créer la heatmap 
p <- ggplot(retards_top20, aes(
  x = Mois_annee,
  y = Departure_station,
  fill = total_retards_arrivee,
  text = paste0(
    "<b>Gare :</b> ", Departure_station, "<br>",
    "<b>Mois :</b> ", Mois_annee, "<br>",
    "<b>Retards à l'arrivée :</b> ", total_retards_arrivee
  )
)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = paste0("Heatmap des retards à l'arrivée par gare - ", annee_selectionnee),
    x = "Mois",
    y = "Gare",
    fill = "Trains en retard"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
    axis.text.y = element_text(size = 10),
    plot.title = element_text(face = "bold", hjust = 0.5),
    panel.grid.major = element_blank()
  )

#  Passer en interactif 
p <- ggplotly(p, tooltip = "text")

#  Affichage 
p


```

<p align="justify">
- Les **retards à l’arrivée** semblent un peu plus diffus, bien qu’ils restent concentrés sur les gares principales.
</p>
**Hypothèse** : **aléas pendant le trajet** (accidents, incidents techniques, météo) 

On détaillera cela dans une prochaine question.

---

### Répartition des retards par gare

```{r echo=FALSE, fig.width=8, fig.height=6, message=FALSE, warning=FALSE}

library(dplyr)
library(tidyr)
library(ggplot2)
library(plotly)

# Construction de la date (si jamais utile plus tard)
data_trains <- data_trains %>%
  mutate(date = as.Date(sprintf("%d-%02d-01", Year, Month)))

# Agréger les retards par gare
retards_gares <- data_trains %>%
  group_by(Departure_station) %>%
  summarise(
    retard_15min = sum(`Number_of_late_trains_>_15min`, na.rm = TRUE),
    retard_30min = sum(`Number_of_late_trains_>_30min`, na.rm = TRUE),
    retard_60min = sum(`Number_of_late_trains_>_60min`, na.rm = TRUE),
    total_retards = sum(Number_of_trains_late_on_arrival, na.rm = TRUE),
    .groups = "drop"
  )

# Top 3 gares
top3_gares <- retards_gares %>%
  arrange(desc(total_retards)) %>%
  slice(1:3)

# Regrouper les autres
autres_gares <- retards_gares %>%
  filter(!(Departure_station %in% top3_gares$Departure_station)) %>%
  summarise(
    Departure_station = "Autres gares",
    retard_15min = sum(retard_15min, na.rm = TRUE),
    retard_30min = sum(retard_30min, na.rm = TRUE),
    retard_60min = sum(retard_60min, na.rm = TRUE),
    total_retards = sum(total_retards, na.rm = TRUE),
    .groups = "drop"
  )

# Combiner top 3 + autres
retards_final <- bind_rows(top3_gares, autres_gares)

# Format long pour ggplot
retards_long <- retards_final %>%
  pivot_longer(cols = c(retard_15min, retard_30min, retard_60min),
               names_to = "Type_retard",
               values_to = "Nombre") %>%
  mutate(
    Type_retard = factor(Type_retard, levels = c("retard_15min", "retard_30min", "retard_60min"))
  )

# Couleurs personnalisées
couleurs_retard <- c(
  "retard_15min" = "#FFEE58",
  "retard_30min" = "#FFA726",
  "retard_60min" = "#EF5350"
)

# Graphique
p <- ggplot(retards_long, aes(
  x = reorder(Departure_station, -Nombre, FUN = sum),
  y = Nombre,
  fill = Type_retard,
  text = paste0(
    "<b>Gare :</b> ", Departure_station, "<br>",
    "Trains en retard : ", Nombre, " trains"
  )
)) +
  geom_col(position = "stack") +
  coord_flip() +
  scale_fill_manual(values = couleurs_retard,
                    labels = c("> 15 min", "> 30 min", "> 60 min")) +
  labs(
    title = "Répartition des retards : Top 3 gares + Autres",
    x = "Gare de départ",
    y = "Nombre de trains en retard",
    fill = "Type de retard"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.text.y = element_text(size = 10)
  )

# Interaction Plotly
p <- ggplotly(p, tooltip = "text")

# Affichage
p



```


- **Histogramme** des 3 gares les plus concernées par les retards en comparaisons aux autres.

---

### Résultats observés

- **Paris Montparnasse**, **Paris Lyon** et **Lyon Part-Dieu** concentrent **plus de 35%** des retards ferroviaires à elles seules.
- Les autres gares contribuent beaucoup moins individuellement.

---

## Conclusion générale Question 1

Grâce aux différents graphiques réalisés, nous pouvons conclure :

- En **2019**, **les retards ferroviaires** sont principalement concentrés sur **quelques grandes gares stratégiques**.
- Il existe une **saisonnalité** des retards : davantage en **été** (vacances, affluence, chaleur) et en **hiver** (conditions climatiques, période de Noël).

Bien que l’analyse porte sur **l'année 2019**, les mêmes **tendances générales** semblent observables sur **2015–2020**.

---

## Perspectives

Plus tard, avec **Shiny**, nous créerons une **application interactive** qui permettra :
- De **filtrer dynamiquement** par année, par gare, par saison,
- D’**explorer les retards ferroviaires** plus efficacement et en temps réel.

Cela permettra de **confirmer ou nuancer** les tendances mises en évidence ici.

---

# Analyse des causes de retard

## Quelles sont les principales causes de retard ?

Nous voulons savoir quelle sont les principales causes de retard. Pour cela, nous calculons la moyenne pour chaque liaison de la proportion des causes.

```{r echo=FALSE, fig.width=8, fig.height=6, message=FALSE, warning=FALSE}

data_trains <- data_trains %>% 
  rename(
    cause_externe = Delay_due_to_external_causes,
    infra_ferroviaire = Delay_due_to_railway_infrastructure,
    gestion_trafic = Delay_due_to_traffic_management,
    materiel_roulant = Delay_due_to_rolling_stock,
    cause_voyageur = Delay_due_to_travellers_taken_into_account,
    retard_station = Delay_due_to_station_management_and_reuse_of_material
  ) 

proportion_retards <- data_trains %>% 
  summarise(across(c(cause_externe, infra_ferroviaire, gestion_trafic, 
                     materiel_roulant, cause_voyageur, retard_station), mean, na.rm = TRUE))

proportion_retards <- proportion_retards %>% 
  pivot_longer(everything(), names_to = "cause", values_to = "moyenne")
proportion_retards <- proportion_retards %>%
  arrange(desc(moyenne))
proportion_retards <- proportion_retards %>% 
  mutate(cause = factor(cause, levels = cause))

ggplot(proportion_retards, aes(x = cause, y = moyenne)) +
  geom_col(fill="skyblue") +
  geom_text(aes(label = round(moyenne, 1), size = moyenne), 
            position = position_stack(vjust = 0.5),
            color = "white") +
  labs(title = "Proportion de retards par cause",
       x = "Cause du retard",
       y = "Pourcentage de retards") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(breaks = seq(0, 30, by = 4)) +
  scale_size_continuous(range = c(5, 10)) +
  guides(size = "none")
```

### Explication du graphe

Ce graphique représente la proportion de cause des retards référencés dans le dataset. Ces causes sont divisées en plusieurs catégories : 

- les causes externes (par exemple le temps, les obstacles sur la voie ou des actions malveillantes)
- l'infrastructure ferroviaire (par exemple pendant des travaux de maintenance)
- la gestion du traffic (par exemple pendant les correspondances)
- le matériel roulant (par exemple lors d'une panne ou d'une anomalie sur la rame)
- le retard en station (par exemple sur la réutilisation du matériel)
- le retard du aux voyageurs (par exemble au moment de l'embarcation)

### Observations

- On peut voir que les causes de retard les plus fréquentes sont celles liées à **l'extérieur** et celles liées à **l'infrastructure ferroviaire**, à respectivement **27%** et **26%** environ. 
- Les retards dûs aux **voyageurs** en eux-mêmes sont beaucoup moins fréquents, n'atteignant pas **4%** des retards renseignés dans le dataset.

## Certaines causes sont-elles plus fréquentes selon les mois ?

Nous avons maintenant une certaine idée de la proportion de chaque cause, mais ce chiffre n'est possiblement pas tout le temps le même. Ici, nous calculons alors de la même manière la proportion de retards, mais cette fois-ci pour chaque mois.

```{r echo=FALSE, fig.width=8, fig.height=6, message=FALSE, warning=FALSE}
proportion_mois <- data_trains %>% 
  group_by(Month) 
proportion_mois <- proportion_mois %>% 
  summarise(across(c(cause_externe, infra_ferroviaire, gestion_trafic, 
                     materiel_roulant, cause_voyageur, retard_station), 
                   mean, na.rm = TRUE)) 
proportion_mois <- proportion_mois %>%
  pivot_longer(cols = -Month, names_to = "cause", values_to = "moyenne")

ggplot(proportion_mois, aes(x = Month, y = moyenne, fill = cause)) +
  geom_col(position = "stack") +
  geom_text(aes(label = round(moyenne, 1)), 
            position = position_stack(vjust = 0.5),
            color = "white", size = 2.5) +
  labs(title = "Proportion des retards par mois et par cause",
       x = "Mois",
       y = "Proportion de retards") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_continuous(breaks = seq(1,12, by = 1), labels = month.abb)
```

### Explication du graphe

Ce graphique, sous forme de **stacked bar plot**, décrit les proportions de causes de retard des trains **selon les mois**, classés dans l'ordre chronologique. Les causes sont les mêmes que celles évoquées dans le précédent graphique

### Observations et hypothèses

On peut alors voir que les proportions restent **sensiblement les même pour la plupart** chaque mois, mais on observe tout de même des **différences notables** lorsqu'on observe plus en détail :

- Les retards pour **causes extérieures** sont **moins fréquentes en été**. Cela peut s'expliquer par la météo, plus clémente pour le réseau ferroviaire en cette période

- On observe un **pic de retard** à cause de **l'infrastructure ferroviaire** en **avril et juin**. On peut alors supposer que la SNCF choisit ces dates pour entreprendre des travaux de maintenance. En effet, ces dates sont proches des vacances d'été et donc proches des fortes affluences qu'il faut préparer.

- Aux mois de **juillet et aout**, les **retards liés aux passagers** sont **plus importants** qu'aux autres mois. Cela peut être dû à la forte affluence amenée par les vacances d'été, entraînant des problèmes d'organisation.

## Certaines causes sont-elles plus fréquentes selon les stations ?

La temporalité n'est pas le seul facteur qui pourrait influencer les causes de retard. En effet, celles-ci peuvent être influencées par l'emplacement de la gare, selon la météo ou la voirie à l'emplacement concerné par exemple.

```{r echo=FALSE, fig.width=8, fig.height=6, message=FALSE, warning=FALSE}

moyennes_depsta <- data_trains %>% 
  group_by(Departure_station) %>% 
  summarise(across(c(cause_externe, infra_ferroviaire, gestion_trafic, 
                     materiel_roulant, cause_voyageur, retard_station), 
                   mean, na.rm = TRUE)) %>%
  pivot_longer(cols = -Departure_station, names_to = "cause", values_to = "moyenne")

ggplot(moyennes_depsta, aes(x = cause, y = Departure_station, fill = moyenne)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "red") +
  labs(title = "Proportion des retards par station de départ et par cause",
       x = "Cause du retard",
       y = "Station",
       fill = "Proportion de retard") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 6),axis.text.y = element_text(size = 7))

```
### Explication du graphe

Ce graphique, sous forme de **heatmap**, décrit les proportions de causes de retard des trains selon les **stations de départ**. Plus la proportion d'une cause de retard est grande, plus la case correspondante tend vers le rouge foncé.

### Observations et hypothèses

On peut alors voir que les proportions restent **sensiblement les même pour la plupart** pour chaque station, mais on observe tout de même des **disparités notables** dans certains cas :

- Les retards pour **causes extérieures** sont **plus fréquents** dans les villes de **Brest, Perpignan et Quimper**. Deux de ces villes étant en Bretagne, il est possible de se dire que le climat de la région amène à plus de retard.

- On observe une **plus grande proportion** de retard à cause de **l'infrastructure ferroviaire au Mans, à Angoulême, à Poitiers ou encore à Angers**. On peut alors supposer, puisque les villes sont plus ou moins proches les unes des autres, que ces travaux de maintenance on eu lieu sur les mêmes infrastructures.

## Conclusion question cause des retards

On a donc appris que les causes de retard les plus fréquentes étaient les causes extérieures et l'infrastructure ferroviaire. Malgré cette tendance remarquée, ces causes peuvent varier selon le temps et les stations concernées.

## Les longs trajets sont-ils plus souvent en retard ?

### Objectif

Nous examinons la relation entre la **durée moyenne** d’un trajet et le **retard moyen à l’arrivée**
Deux approches : 

- Scatterplot
- Boxplot

```{r}
trajets <- data_trains

```

```{r}
trajets %>% 
  filter(
    !is.na(Average_travel_time),
    !is.na(Average_delay_of_all_arriving_trains)
  ) %>% 
  ggplot(aes(x = Average_travel_time,
             y = Average_delay_of_all_arriving_trains)) +
  geom_point(alpha = .6) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(
    title = "Durée moyenne du trajet vs retard moyen (brut)",
    x = "Durée moyenne (min)",
    y = "Retard moyen à l’arrivée (min)"
  ) +
  theme_minimal()
```

### Explication du graphe

Axe X : La durée moyenne des trajets du dataset.
Axe Y : retard moyen à l’arrivée.
Chaque point = une liaison ; 
Ligne rouge = régression linéaire.

### Observations et hypothèses

Nuage très dispersé, on voit quelques valeurs extrêmes (> 200 min de retard) qui tirent la pente vers le haut.

```{r}
trajets %>% 
  filter(
    !is.na(Average_travel_time),
    !is.na(Average_delay_of_all_arriving_trains),
    between(Average_delay_of_all_arriving_trains, -60, 120)
  ) %>% 
  ggplot(aes(x = Average_travel_time,
             y = Average_delay_of_all_arriving_trains)) +
  geom_point(alpha = .6) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(
    title = "Durée vs retard (valeurs extrêmes exclues)",
    x = "Durée moyenne (min)",
    y = "Retard moyen à l’arrivée (min)"
  ) +
  theme_minimal()
```

### Explication du graphe

Identique au précédent, on enlève les outliers problématiques pour ajuster le graphique et qu'il soit plus représentatif.

### Observations et hypothèses

Dispersion verticale quasiment constante jusqu’à ~180 min ; au-delà, la variabilité augmente.

Les retards extrêmes observés sur la première figure sont soit des erreurs soit le résultat d'erreur de données
La durée du trajet n’explique qu’une petite partie des retards, d’autres facteurs (infrastructure, matériel, trafic, météo...) sont très sûrement en cause.

```{r}
trajets %>% 
  filter(
    !is.na(Average_travel_time), !is.na(Average_delay_of_all_arriving_trains),
    between(Average_delay_of_all_arriving_trains, -60, 120)
  ) %>% 
  mutate(
    travel_time_bin = cut(
      Average_travel_time,
      breaks = seq(
        0,
        max(Average_travel_time, na.rm = TRUE) + 30,  by = 30 ),
      right = FALSE,
      include.lowest = TRUE
    )
  ) %>% 
  ggplot(aes(x = travel_time_bin,
             y = Average_delay_of_all_arriving_trains)) +
  geom_boxplot() +
  coord_flip() +
  labs(
    title = "Retard moyen par tranche de durée", x = "Tranche de durée (min)",
    y = "Retard moyen (min)"
  ) +
  theme_minimal()
```

### Explication du graphe

Chaque boîte correspond à une tranche de 30 min de durée. Elle montre la distribution du retard moyen pour une tranche de durée du trajet.

### Observations et hypothèses

Médiane proche de 6 min jusqu’à la tranche 120-150 min, puis hausse continue.
Les valeurs atypiques s’allongent après 180 min, on peut observer que les longs trajets ont plus souvent des retards supérieur à 30 min.

Les trajets courts subissent plutôt des petits retards mais fréquents.

## Conclusion Retard vs durée de trajet

La durée du trajet contribue aux retards, surtout quand elle dépasse 3 heures.

En retirant les outliers, la corrélation devient modeste, les retards se jouent sur une multitude de facteurs plus que sur la distance du trajet.

Pour comprendre les causes, il faudra donc croiser la durée par exemple avec :

-Type de ligne.
-Période/saison.

Et dans un second temps regarder les catégorie de cause déjà présentes comme l'infrastructure, le matériel ou les voyageurs
